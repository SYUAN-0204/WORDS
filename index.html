<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>描寫比對挑戰</title>
  <style>
    body { margin: 0; font-family: sans-serif; text-align: center; }
    canvas {
      border: 2px solid #444;
      touch-action: none;
      background: white;
    }
    .btns {
      margin-top: 10px;
    }
    button {
      padding: 0.8em 1.2em;
      font-size: 1em;
      margin: 0 0.5em;
    }
  </style>
</head>
<body>
  <h2>描寫比對挑戰（字：漢）</h2>
  <canvas id="canvas" width="300" height="300"></canvas>
  <div class="btns">
    <button id="clearBtn">清除</button>
    <button id="compareBtn">比對相似度</button>
    <p id="resultText"></p>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const resultText = document.getElementById('resultText');

    const width = canvas.width;
    const height = canvas.height;

    // Step 1: 繪製標準範例字（背景）
    const drawStandardCharacter = () => {
      ctx.clearRect(0, 0, width, height);
      ctx.font = "bold 200px 'KaiTi', 'serif'";
      ctx.fillStyle = "rgba(200, 200, 200, 0.3)"; // 灰色字當背景參考
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("漢", width / 2, height / 2);
    };

    // Step 2: 使用者繪圖層（黑色線）
    let isDrawing = false;
    let lastX = 0, lastY = 0;

    const drawLine = (x, y) => {
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 3;
      ctx.lineCap = "round";
      ctx.stroke();
      lastX = x;
      lastY = y;
    };

    canvas.addEventListener('touchstart', e => {
      e.preventDefault();
      isDrawing = true;
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      lastX = touch.clientX - rect.left;
      lastY = touch.clientY - rect.top;
    });

    canvas.addEventListener('touchmove', e => {
      if (!isDrawing) return;
      e.preventDefault();
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;
      drawLine(x, y);
    });

    canvas.addEventListener('touchend', () => {
      isDrawing = false;
    });

    // Step 3: 清除畫面
    document.getElementById('clearBtn').addEventListener('click', () => {
      drawStandardCharacter();
      resultText.textContent = '';
    });

    // Step 4: 比對相似度（圖像重疊簡易版）
    document.getElementById('compareBtn').addEventListener('click', () => {
      const imgData = ctx.getImageData(0, 0, width, height);
      let match = 0, total = 0;

      for (let i = 0; i < imgData.data.length; i += 4) {
        const r = imgData.data[i];
        const g = imgData.data[i + 1];
        const b = imgData.data[i + 2];
        const a = imgData.data[i + 3];

        // 使用者畫的線條是黑色（0,0,0），alpha > 100
        if (r < 50 && g < 50 && b < 50 && a > 100) {
          total++;

          // 背景灰色字：200~220範圍，這裡用原色混合重疊來估計有無交疊
          if (r + g + b < 600) match++;
        }
      }

      const percent = total === 0 ? 0 : Math.round((match / total) * 100);
      resultText.textContent = `相似度：約 ${percent}%`;
    });

    // 初始化
    drawStandardCharacter();
  </script>
</body>
</html>
